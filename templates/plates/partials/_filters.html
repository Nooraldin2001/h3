{% load i18n static %}
<form
  id="filters"
  hx-get="{% url 'plates:plates_list_partial' %}"
  hx-target="#list-container"
  hx-trigger="change delay:300ms, keyup delay:500ms from:input"
  hx-push-url="true"
>
  <div class="fillter">
    <div class="container">
      <div class="content partsFillter showMorePart" dir="auto">
        <div class="part1">
          <img
            src="{% static 'css/fillter.png' %}"
            class="imgFillter"
            alt="Filter"
          />
          <h4>{% trans "Filter Plates" %}</h4>
        </div>
        <div class="boxTwo">
          <div class="parts">
            <div class="part">
              <div class="form-group">
                <select name="emirate" class="form-control">
                  <option value="">{% trans "Emirate" %}</option>
                  {% for e in emirates %}
                  <option value="{{ e.slug }}">{{ e.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="part">
              <div class="form-group">
                <select name="type" class="form-control">
                  <option value="">{% trans "Type" %}</option>
                  {% for t in types %}
                  <option value="{{ t.slug }}">{{ t.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="part">
              <div class="form-group">
                <select name="letter" class="form-control">
                  <option value="">{% trans "Code" %}</option>
                  <option value="-">-</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                  <option value="13">13</option>
                  <option value="14">14</option>
                  <option value="15">15</option>
                  <option value="16">16</option>
                  <option value="17">17</option>
                  <option value="18">18</option>
                  <option value="19">19</option>
                  <option value="50">50</option>
                  <option value="?">?</option>
                  <option value="A">A</option>
                  <option value="AA">AA</option>
                  <option value="B">B</option>
                  <option value="BB">BB</option>
                  <option value="C">C</option>
                  <option value="CC">CC</option>
                  <option value="D">D</option>
                  <option value="DD">DD</option>
                  <option value="E">E</option>
                  <option value="EE">EE</option>
                  <option value="F">F</option>
                  <option value="G">G</option>
                  <option value="H">H</option>
                  <option value="I">I</option>
                  <option value="J">J</option>
                  <option value="K">K</option>
                  <option value="L">L</option>
                  <option value="M">M</option>
                  <option value="N">N</option>
                  <option value="O">O</option>
                  <option value="P">P</option>
                  <option value="Q">Q</option>
                  <option value="R">R</option>
                  <option value="S">S</option>
                  <option value="T">T</option>
                  <option value="U">U</option>
                  <option value="V">V</option>
                  <option value="W">W</option>
                  <option value="X">X</option>
                  <option value="Y">Y</option>
                  <option value="Z">Z</option>
                </select>
              </div>
            </div>
            <div class="part more">
              <div class="form-group">
                <input
                  name="search"
                  type="text"
                  maxlength="5"
                  placeholder="{% trans 'Contains: e.g. 700' %}"
                />
              </div>
            </div>
            <div class="part more">
              <div class="form-group">
                <input
                  name="max_price"
                  type="number"
                  placeholder="{% trans 'Max price' %}"
                  style="text-align: right; direction: rtl"
                  dir="auto"
                />
              </div>
            </div>
            <div class="part more">
              <div class="form-group">
                <input
                  name="min_price"
                  type="number"
                  placeholder="{% trans 'Min price' %}"
                  style="text-align: right; direction: rtl"
                  dir="auto"
                />
              </div>
            </div>
            <div class="part more">
              <div class="form-group">
                <input
                  name="starts_with"
                  type="text"
                  maxlength="5"
                  placeholder="{% trans 'Starts with: e.g. 123' %}"
                />
              </div>
            </div>
            <div class="part more">
              <div class="form-group">
                <input
                  name="ends_with"
                  type="text"
                  maxlength="5"
                  placeholder="{% trans 'Ends with: e.g. 222' %}"
                />
              </div>
            </div>
            <div class="part">
              <div class="form-group">
                <select name="numbers_count" class="form-control">
                  <option value="">{% trans "Number of digits" %}</option>
                  <option value="1">1 {% trans "digit" %}</option>
                  <option value="2">2 {% trans "digits" %}</option>
                  <option value="3">3 {% trans "digits" %}</option>
                  <option value="4">4 {% trans "digits" %}</option>
                  <option value="5">5 {% trans "digits" %}</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
  (function () {
    const form = document.getElementById("filters");
    if (!form) return;

    const emirateSelect = form.querySelector('select[name="emirate"]');
    const letterSelect = form.querySelector('select[name="letter"]');
    if (!emirateSelect || !letterSelect) return;

    // Emirate-specific code options (supports both numeric and slug-style emirate values)
    const codesByEmirate = {
      // Abu Dhabi: 1-19, 50, ?
      1: [
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "16",
        "17",
        "18",
        "19",
        "50",
        "?",
      ],
      "abu-dhabi": [
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "16",
        "17",
        "18",
        "19",
        "50",
        "?",
      ],
      abudhabi: [
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "16",
        "17",
        "18",
        "19",
        "50",
        "?",
      ],

      // Dubai: A-Z, AA, BB, CC, DD, EE, ?
      2: [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "AA",
        "BB",
        "CC",
        "DD",
        "EE",
        "?",
      ],
      dubai: [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "AA",
        "BB",
        "CC",
        "DD",
        "EE",
        "?",
      ],

      // Ras Al Khaimah: A-Z, ?
      3: [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "?",
      ],
      "ras-al-khaimah": [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "?",
      ],
      "ras-alkhaimah": [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "?",
      ],

      // Fujairah: A-Z, ?
      4: [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "?",
      ],
      fujairah: [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "?",
      ],
      "al-fujairah": [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "?",
      ],

      // Ajman: A-Z, ?
      5: [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "?",
      ],
      ajman: [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "?",
      ],

      // Umm Al Quwain: A-Z, ?
      6: [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "?",
      ],
      "umm-al-quwain": [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "?",
      ],
      "umm-alquwain": [
        "A",
        "B",
        "C",
        "D",
        "E",
        "F",
        "G",
        "H",
        "I",
        "J",
        "K",
        "L",
        "M",
        "N",
        "O",
        "P",
        "Q",
        "R",
        "S",
        "T",
        "U",
        "V",
        "W",
        "X",
        "Y",
        "Z",
        "?",
      ],

      // Sharjah: 1-19, ?
      7: [
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "16",
        "17",
        "18",
        "19",
        "?",
      ],
      sharjah: [
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "16",
        "17",
        "18",
        "19",
        "?",
      ],
      "al-sharjah": [
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "16",
        "17",
        "18",
        "19",
        "?",
      ],
    };

    function normalizeEmirateKey(v) {
      const raw = (v || "").toString().trim();
      if (!raw) return "";
      if (/^\d+$/.test(raw)) return raw; // numeric slugs like "1"
      return raw
        .toLowerCase()
        .replace(/[_\s]+/g, "-")
        .replace(/[^a-z0-9-]/g, "");
    }

    function rebuildLetterOptions() {
      const emirateKey = normalizeEmirateKey(emirateSelect.value);
      const allowed = codesByEmirate[emirateKey] || null;
      const current = letterSelect.value;

      // Always include blank + "-" (matches existing filter behavior)
      const base = ["-"];
      const next = allowed ? base.concat(allowed) : null;

      // If no emirate selected, keep the existing full list (user can choose anything)
      if (!next) return;

      const opts = [
        `<option value="">{% trans "Code" %}</option>`,
        ...next.map((c) => `<option value="${c}">${c}</option>`),
      ].join("");

      letterSelect.innerHTML = opts;

      // Restore selection if still valid; otherwise clear it
      if (current && next.includes(current)) {
        letterSelect.value = current;
      } else {
        letterSelect.value = "";
      }
    }

    // Update code list immediately when emirate changes (before HTMX sends request)
    emirateSelect.addEventListener(
      "change",
      function () {
        const before = letterSelect.value;
        rebuildLetterOptions();
        // If we cleared an invalid selection, trigger HTMX update by firing change on letter
        if (before && letterSelect.value === "") {
          letterSelect.dispatchEvent(new Event("change", { bubbles: true }));
        }
      },
      true
    );

    // On load (supports deep links with query params)
    rebuildLetterOptions();
  })();
</script>
