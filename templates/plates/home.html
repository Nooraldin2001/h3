{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "Plates" %}{% endblock %}

{% block content %}
<div class="container">
	<div class="sliderImgs">
		<div class="swiper mySwiper">
			<div class="swiper-wrapper">
				<div class="swiper-slide">
					<img alt="H3 Auctions Slide 1" src="{% static 'css/slider_1.png' %}" onerror="this.src='{% static 'css/h3-logo.jpg' %}'">
				</div>
				<div class="swiper-slide">
					<img alt="H3 Auctions Slide 2" src="{% static 'css/slider_2.png' %}" onerror="this.src='{% static 'css/h3-logo.jpg' %}'">
				</div>
				<div class="swiper-slide">
					<img alt="H3 Auctions Slide 3" src="{% static 'css/slider_3.png' %}" onerror="this.src='{% static 'css/h3-logo.jpg' %}'">
				</div>
					<div class="swiper-slide">
					<img alt="H3 Auctions Slide 4" src="{% static 'css/slider_4.png' %}" onerror="this.src='{% static 'css/h3-logo.jpg' %}'">
					</div>
			</div>
			<div class="swiper-pagination"></div>
		</div>
	</div>
</div>

<div class="about">
	<h1>{% trans "Buy, sell and design vehicle plates" %}</h1>
	<h2>{% trans "In simple steps" %}</h2>
</div>

{% include "plates/partials/_filters.html" %}

<section class="sectionCars">
	<div class="container">
		<div class="cars">
			<div id="list-container" hx-get="{% url 'plates:plates_list_partial' %}" hx-trigger="load" hx-target="#list-container">
				<div class="text-center text-muted py-5">{% trans "Loading..." %}</div>
			</div>
		</div>
	</div>
</section>

<section class="records-section">
	<div class="container">
		<div class="records-header text-center">
			<h2 class="records-title">{% trans "Our Records" %}</h2>
			<p class="records-subtitle">{% trans "Real results from H3 Auctions" %}</p>
		</div>

		<div class="row g-4 justify-content-center">
			<div class="col-12 col-md-6 col-lg-5">
				<div class="records-card">
					<div class="records-value">
						<span class="records-counter" data-target="5000" data-duration="2600" data-loop="true">0</span><span class="records-suffix">+</span>
					</div>
					<div class="records-label">{% trans "Sold plates" %}</div>
				</div>
			</div>

			<div class="col-12 col-md-6 col-lg-5">
				<div class="records-card">
					<div class="records-value">
						<span class="records-counter" data-target="95" data-duration="2200" data-loop="true">0</span><span class="records-suffix">%</span>
					</div>
					<div class="records-progress" aria-hidden="true">
						<div class="records-progress-bar" data-percent="95"></div>
					</div>
					<div class="records-label">{% trans "of presented numbers have been sold" %}</div>
				</div>
			</div>
		</div>
	</div>
</section>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			new Swiper(".mySwiper", {
				spaceBetween: 30,
				autoplay: {delay: 3000},
				pagination: {el: ".swiper-pagination", clickable: true},
			{% if LANGUAGE_CODE == 'ar' %}rtl: true,{% endif %}
			});

			// Records counters (animated)
			const recordsSection = document.querySelector(".records-section");
			if (!recordsSection) return;

			const prefersReduced = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

			function formatNumber(n) {
				return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
			}

			function animateCounter(el) {
				const target = Number(el.dataset.target || "0");
				const duration = Number(el.dataset.duration || "2000");
				const loop = (el.dataset.loop || "false") === "true";
				const isPercent = el.nextElementSibling && el.nextElementSibling.classList.contains("records-suffix") && el.nextElementSibling.textContent.trim() === "%";

				let rafId = null;
				let startTs = null;

				const start = () => {
					startTs = null;
					if (rafId) cancelAnimationFrame(rafId);

					const tick = (ts) => {
						if (startTs === null) startTs = ts;
						const t = Math.min(1, (ts - startTs) / duration);
						// easeOutCubic
						const eased = 1 - Math.pow(1 - t, 3);
						const value = eased * target;
						el.textContent = isPercent ? String(Math.round(value)) : formatNumber(value);
						if (t < 1) {
							rafId = requestAnimationFrame(tick);
						} else if (loop) {
							setTimeout(() => {
								el.textContent = "0";
								start();
							}, 900);
						}
					};

					rafId = requestAnimationFrame(tick);
				};

				if (prefersReduced) {
					el.textContent = isPercent ? String(target) : formatNumber(target);
					return;
				}

				start();
			}

			function animateProgressBars() {
				recordsSection.querySelectorAll(".records-progress-bar").forEach((bar) => {
					const percent = Math.max(0, Math.min(100, Number(bar.dataset.percent || "0")));
					if (prefersReduced) {
						bar.style.width = percent + "%";
						return;
					}
					bar.animate([{ width: "0%" }, { width: percent + "%" }], {
						duration: 1200,
						easing: "cubic-bezier(0.22, 1, 0.36, 1)",
						fill: "forwards",
					});
				});
			}

			let started = false;
			const io = new IntersectionObserver(
				(entries) => {
					if (started) return;
					if (entries.some((e) => e.isIntersecting)) {
						started = true;
						recordsSection.querySelectorAll(".records-counter").forEach(animateCounter);
						animateProgressBars();
					}
				},
				{ threshold: 0.25 }
			);

			io.observe(recordsSection);
		});
	</script>
{% endblock %}
